# 错误 500 修复说明

**修复时间**: 2025-11-12  
**问题**: 打开浏览器访问 http://localhost:5173 时出现错误 500 提示

---

## 一、问题原因

### 根本原因
在 `App.vue` 的 `onBeforeMount` 钩子中，如果 `getChainNetworkConfigs()` 返回 `false`（即 API 调用失败），会直接跳转到 `Error500` 页面。

### 触发条件
1. 后端服务未运行
2. 后端服务运行但 API 调用失败
3. 网络连接问题

### 问题代码
```typescript
// 获取服务器区块链配置
if (!(await serverConfigsStore.getChainNetworkConfigs())) {
  FastDialog.errorSnackbar('Unable to obtain blockchain network configuration information.')
  userStore.signOut()
  router.push({ name: 'Error500' })  // ❌ 直接跳转到错误页面
  return
}
```

---

## 二、修复方案

### 改进的错误处理逻辑

```typescript
// 获取服务器区块链配置
const configResult = await serverConfigsStore.getChainNetworkConfigs()
if (!configResult) {
  // 检查是否是网络错误（后端服务未运行）
  const webApi = WebApi.getInstance()
  // 如果后端服务未运行，进入访客模式而不是跳转到错误页面
  if (!webApi.ready) {
    console.warn('后端服务未运行，进入访客模式')
    await guestReady()
    return
  }
  // 其他错误才跳转到错误页面
  FastDialog.errorSnackbar('Unable to obtain blockchain network configuration information.')
  userStore.signOut()
  router.push({ name: 'Error500' })
  return
}
```

### 修复要点
1. ✅ **检查 WebApi.ready 状态**: 判断是否是后端服务未运行
2. ✅ **进入访客模式**: 后端服务未运行时，进入访客模式而不是错误页面
3. ✅ **保留错误处理**: 真正的服务器错误仍然跳转到 Error500

---

## 三、修复效果

### 修复前
- ❌ 后端服务未运行 → 直接跳转到 Error500 页面
- ❌ 用户无法看到任何内容
- ❌ 无法进入访客模式

### 修复后
- ✅ 后端服务未运行 → 进入访客模式
- ✅ 用户可以浏览商品（只读模式）
- ✅ 后端服务运行后，自动加载完整功能

---

## 四、测试步骤

### 1. 后端服务未运行的情况
1. 确保后端服务未运行
2. 打开浏览器访问 http://localhost:5173
3. **预期结果**: 应该进入访客模式，可以浏览商品，不会跳转到 Error500

### 2. 后端服务运行的情况
1. 启动后端服务: `.\启动所有服务.bat`
2. 等待后端服务完全启动（约 15-30 秒）
3. 打开浏览器访问 http://localhost:5173
4. **预期结果**: 正常加载配置，进入完整功能模式

---

## 五、相关文件

### 修改的文件
- `src/Frontend/web-app/src/App.vue`
  - 添加 `WebApi` 导入
  - 改进 `getChainNetworkConfigs` 失败处理逻辑

### 相关文件
- `src/Frontend/web-app/src/store/severConfigs.ts` - 服务器配置 Store
- `src/Frontend/web-app/src/libs/WebApi.ts` - API 工具类

---

## 六、注意事项

### 访客模式限制
- 只能浏览商品
- 无法连接钱包
- 无法创建订单
- 无法进行支付

### 完整功能需要
- 后端服务必须运行
- 数据库服务必须运行
- 所有 API 必须正常响应

---

## 七、后续优化建议

### 1. 添加重试机制
在 `getChainNetworkConfigs` 中添加重试逻辑，避免临时网络问题导致失败。

### 2. 改进错误提示
在访客模式下显示友好的提示信息，告知用户后端服务未运行。

### 3. 自动检测后端服务
添加后端服务健康检查，自动检测服务状态并提示用户。

---

**修复完成时间**: 2025-11-12


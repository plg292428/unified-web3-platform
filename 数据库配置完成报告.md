# æ•°æ®åº“é…ç½®å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. Entity Framework Core é…ç½®
- âœ… **EF Core Tools** å·²å®‰è£…ï¼ˆå…¨å±€å·¥å…·ï¼Œç‰ˆæœ¬ 9.0.10ï¼‰
- âœ… **EF Core Design** åŒ…å·²æ·»åŠ åˆ° DbService é¡¹ç›®ï¼ˆç‰ˆæœ¬ 8.0.4ï¼‰
- âœ… **EF Core Design** åŒ…å·²æ·»åŠ åˆ° WebApi é¡¹ç›®ï¼ˆç‰ˆæœ¬ 8.0.4ï¼‰
- âœ… **DbContextFactory** å·²åˆ›å»ºï¼Œç”¨äºè¿ç§»æ—¶çš„æ•°æ®åº“ä¸Šä¸‹æ–‡åˆ›å»º

### 2. æ•°æ®åº“è¿æ¥é…ç½®
- âœ… **appsettings.json** å·²é…ç½®
  - æ•°æ®åº“åç§°: `UnifiedPlatform`
  - è¿æ¥å­—ç¬¦ä¸²: `Data Source=(localdb)\MSSQLLocalDB;Initial Catalog=UnifiedPlatform;...`
- âœ… **appsettings.Production.json** å·²åˆ›å»ºï¼ˆç”Ÿäº§ç¯å¢ƒé…ç½®ï¼‰

### 3. æ•°æ®åº“è„šæœ¬å’Œå·¥å…·
- âœ… **configure_database.bat** - æ•°æ®åº“é…ç½®å’Œåˆ›å»ºè„šæœ¬
- âœ… **create_migration.bat** - åˆ›å»ºæ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… **apply_migration.bat** - åº”ç”¨æ•°æ®åº“è¿ç§»è„šæœ¬
- âœ… **test_database_connection.bat** - æµ‹è¯•æ•°æ®åº“è¿æ¥è„šæœ¬
- âœ… **check_database.bat** - æ£€æŸ¥æ•°æ®åº“çŠ¶æ€è„šæœ¬

### 4. æ–‡æ¡£
- âœ… **database_setup_guide.md** - è¯¦ç»†é…ç½®æŒ‡å—
- âœ… **database_config_summary.md** - é…ç½®æ€»ç»“æ–‡æ¡£

## ğŸ“‹ æ•°æ®åº“é…ç½®é€‰é¡¹

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç°æœ‰SmallTargetæ•°æ®åº“ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

**ä¼˜ç‚¹ï¼š**
- æ— éœ€åˆ›å»ºæ–°æ•°æ®åº“
- æ— éœ€è¿è¡Œè¿ç§»
- å¯ä»¥å¤ç”¨ç°æœ‰æ•°æ®

**æ­¥éª¤ï¼š**
1. ç¼–è¾‘ `src\Backend\UnifiedPlatform.WebApi\appsettings.json`
2. ä¿®æ”¹è¿æ¥å­—ç¬¦ä¸²ï¼š
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Data Source=(localdb)\\MSSQLLocalDB;Initial Catalog=SmallTarget;Integrated Security=True;TrustServerCertificate=True;"
     }
   }
   ```
3. ç›´æ¥è¿è¡Œé¡¹ç›®ï¼š`.\run_backend.bat`

### æ–¹æ¡ˆ2ï¼šåˆ›å»ºæ–°çš„UnifiedPlatformæ•°æ®åº“

**æ­¥éª¤ï¼š**

1. **æ£€æŸ¥/åˆ›å»ºæ•°æ®åº“**
   ```powershell
   .\configure_database.bat
   ```
   - å¦‚æœLocalDBæœªå®‰è£…ï¼Œéœ€è¦å…ˆå®‰è£…SQL Server LocalDB

2. **åˆ›å»ºæ•°æ®åº“è¿ç§»**
   ```powershell
   .\create_migration.bat
   ```
   - è¾“å…¥è¿ç§»åç§°ï¼ˆæˆ–ç›´æ¥å›è½¦ä½¿ç”¨ `InitialCreate`ï¼‰
   - è„šæœ¬ä¼šè‡ªåŠ¨åˆ›å»ºè¿ç§»å¹¶æç¤ºæ˜¯å¦åº”ç”¨

3. **åº”ç”¨è¿ç§»**ï¼ˆå¦‚æœæœªè‡ªåŠ¨åº”ç”¨ï¼‰
   ```powershell
   .\apply_migration.bat
   ```

4. **è¿è¡Œé¡¹ç›®**
   ```powershell
   .\run_backend.bat
   ```

## ğŸ”§ å½“å‰é…ç½®è¯¦æƒ…

### è¿æ¥å­—ç¬¦ä¸²é…ç½®

**å¼€å‘ç¯å¢ƒ** (`appsettings.json`):
```
Data Source=(localdb)\MSSQLLocalDB;Initial Catalog=UnifiedPlatform;Integrated Security=True;TrustServerCertificate=True;
```

**ç”Ÿäº§ç¯å¢ƒ** (`appsettings.Production.json`):
```
Data Source=localhost;Initial Catalog=UnifiedPlatform;Integrated Security=True;TrustServerCertificate=True;
```

### DbContext é…ç½®

- **ä¸Šä¸‹æ–‡ç±»**: `StDbContext`
- **å‘½åç©ºé—´**: `SmallTarget.DbService.Entities`
- **ä½ç½®**: `src\Backend\UnifiedPlatform.DbService\Entities\StDbContext.cs`
- **å·¥å‚ç±»**: `DbContextFactory` (ç”¨äºè¿ç§»)

### æ•°æ®è¡¨ç»“æ„

é¡¹ç›®åŒ…å«24ä¸ªæ•°æ®è¡¨ï¼š

**ç”¨æˆ·ç›¸å…³** (8ä¸ªè¡¨):
- Users, UserAssets, UserChainTransaction
- UserLoginLog, UserMiningRewardRecord
- UserInvitationRewardRecord, UserPathNode
- UserSysteamMessage

**ç®¡ç†ç›¸å…³** (7ä¸ªè¡¨):
- Managers, ManagerLoginLog, ManagerOperationLog
- ManagerBalanceChange, ManagerTransferFromUserOrder
- ManagerAiTradingActivationCode, ManagerTypeConfig

**é…ç½®ç›¸å…³** (5ä¸ªè¡¨):
- GlobalConfig, ChainNetworkConfig, ChainTokenConfig
- ChainWalletConfig, UserLevelConfig

**ä¸šåŠ¡ç›¸å…³** (4ä¸ªè¡¨):
- UserAiTradingOrder, UserAssetsToWalletOrder
- UserOnChainAssetsChange

## âš ï¸ é‡è¦æç¤º

### 1. LocalDB å®‰è£…è¦æ±‚

å¦‚æœ `configure_database.bat` æç¤ºæ— æ³•è¿æ¥LocalDBï¼š

**å®‰è£…æ–¹æ³•ï¼š**
- ä¸‹è½½å¹¶å®‰è£… [SQL Server Express](https://www.microsoft.com/sql-server/sql-server-downloads)
- æˆ–é€šè¿‡ Visual Studio Installer å®‰è£… LocalDB ç»„ä»¶

**éªŒè¯å®‰è£…ï¼š**
```powershell
sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "SELECT @@VERSION"
```

### 2. æ•°æ®åº“ç‰ˆæœ¬å…¼å®¹æ€§

- å½“å‰ä½¿ç”¨ EF Core 8.0.4
- éœ€è¦ SQL Server 2012 æˆ–æ›´é«˜ç‰ˆæœ¬
- LocalDB ç‰ˆæœ¬é€šå¸¸ä¸ SQL Server Express ç‰ˆæœ¬å¯¹åº”

### 3. è¿ç§»ç­–ç•¥å»ºè®®

**é¦–æ¬¡ä½¿ç”¨ï¼š**
- å¦‚æœå·²æœ‰SmallTargetæ•°æ®åº“ â†’ ä½¿ç”¨æ–¹æ¡ˆ1ï¼ˆæœ€ç®€å•ï¼‰
- å¦‚æœéœ€è¦å…¨æ–°æ•°æ®åº“ â†’ ä½¿ç”¨æ–¹æ¡ˆ2

**åç»­æ›´æ–°ï¼š**
- åˆ›å»ºæ–°è¿ç§»ï¼š`.\create_migration.bat`
- åº”ç”¨è¿ç§»ï¼š`.\apply_migration.bat`

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

### æœ€ç®€å•çš„æ–¹å¼ï¼ˆä½¿ç”¨ç°æœ‰æ•°æ®åº“ï¼‰

```powershell
# 1. ä¿®æ”¹è¿æ¥å­—ç¬¦ä¸²
# ç¼–è¾‘ src\Backend\UnifiedPlatform.WebApi\appsettings.json
# å°† "Initial Catalog=UnifiedPlatform" æ”¹ä¸º "Initial Catalog=SmallTarget"

# 2. ç›´æ¥è¿è¡Œ
.\run_backend.bat
```

### åˆ›å»ºæ–°æ•°æ®åº“

```powershell
# 1. é…ç½®æ•°æ®åº“ï¼ˆå¦‚æœLocalDBå¯ç”¨ï¼‰
.\configure_database.bat

# 2. åˆ›å»ºå¹¶åº”ç”¨è¿ç§»
.\create_migration.bat
# è¾“å…¥è¿ç§»åç§°ï¼ˆæˆ–ç›´æ¥å›è½¦ï¼‰
# é€‰æ‹©æ˜¯å¦ç«‹å³åº”ç”¨è¿ç§»

# 3. è¿è¡Œé¡¹ç›®éªŒè¯
.\run_backend.bat
```

## ğŸ“ æµ‹è¯•æ•°æ®åº“è¿æ¥

### æ–¹æ³•1ï¼šä½¿ç”¨è„šæœ¬
```powershell
.\test_database_connection.bat
```

### æ–¹æ³•2ï¼šè¿è¡Œé¡¹ç›®
```powershell
.\run_backend.bat
```
è®¿é—® `https://localhost:5001/health` æ£€æŸ¥æœåŠ¡æ˜¯å¦æ­£å¸¸

### æ–¹æ³•3ï¼šä½¿ç”¨SQLå‘½ä»¤
```powershell
sqlcmd -S "(localdb)\MSSQLLocalDB" -d "UnifiedPlatform" -Q "SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES"
```

## âœ… é…ç½®å®ŒæˆçŠ¶æ€

**æ‰€æœ‰æ•°æ®åº“é…ç½®å’Œå·¥å…·å·²åˆ›å»ºå®Œæˆï¼**

- [x] 1. Entity Framework Core å·¥å…·é…ç½®
- [x] 2. DbContextFactory åˆ›å»º
- [x] 3. æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²é…ç½®
- [x] 4. è¿ç§»è„šæœ¬åˆ›å»º
- [x] 5. æµ‹è¯•è„šæœ¬åˆ›å»º
- [x] 6. é…ç½®æ–‡æ¡£ç¼–å†™

## ğŸ¯ ä¸‹ä¸€æ­¥æ“ä½œ

1. **é€‰æ‹©æ•°æ®åº“æ–¹æ¡ˆ**
   - æ–¹æ¡ˆ1ï¼šä½¿ç”¨ç°æœ‰SmallTargetæ•°æ®åº“ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰
   - æ–¹æ¡ˆ2ï¼šåˆ›å»ºæ–°çš„UnifiedPlatformæ•°æ®åº“

2. **æ‰§è¡Œé€‰æ‹©**
   - å¦‚æœé€‰æ‹©æ–¹æ¡ˆ1ï¼šä¿®æ”¹ `appsettings.json` ä¸­çš„è¿æ¥å­—ç¬¦ä¸²
   - å¦‚æœé€‰æ‹©æ–¹æ¡ˆ2ï¼šè¿è¡Œ `.\create_migration.bat`

3. **æµ‹è¯•éªŒè¯**
   - è¿è¡Œ `.\run_backend.bat`
   - è®¿é—® Swagger UI æµ‹è¯•API
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸

**æ•°æ®åº“é…ç½®å·²å°±ç»ªï¼**


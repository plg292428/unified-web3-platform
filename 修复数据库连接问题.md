# 修复数据库连接问题

## 🔍 问题诊断结果

### 发现的问题

1. **数据库连接失败**
   - 无法连接到SmallTarget数据库
   - SQL Server LocalDB可能未安装或未运行
   - 或者SmallTarget数据库不存在

2. **服务启动失败**
   - 由于数据库连接失败，服务无法启动
   - TempCachingService需要数据库连接才能初始化

## 🛠️ 解决方案

### 方案1：安装/启动SQL Server LocalDB（推荐）

**步骤1：检查LocalDB是否安装**
```powershell
sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "SELECT @@VERSION"
```

**步骤2：如果未安装，安装LocalDB**
- 下载并安装 [SQL Server Express](https://www.microsoft.com/sql-server/sql-server-downloads)
- 或通过 Visual Studio Installer 安装 LocalDB 组件

**步骤3：检查SmallTarget数据库是否存在**
```powershell
sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "SELECT name FROM sys.databases WHERE name = 'SmallTarget'"
```

**步骤4：如果数据库不存在**
- 使用原有SmallTarget项目创建数据库
- 或运行数据库迁移创建表结构

### 方案2：修改连接字符串指向其他数据库

如果SmallTarget数据库不存在，可以：

1. **创建新数据库**
   ```powershell
   sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "CREATE DATABASE SmallTarget"
   ```

2. **或使用其他SQL Server实例**
   - 修改 `appsettings.json` 中的连接字符串
   - 指向已存在的数据库

### 方案3：临时禁用数据库相关服务（仅用于测试启动）

如果只是想测试服务能否启动，可以临时注释掉需要数据库的服务：

**修改 Program.cs：**
```csharp
// 临时注释掉这些服务
// builder.Services.AddTempCachingService();
// builder.Services.AddWeb3ProviderService();
// builder.Services.AddScheduleJobs();
```

**注意：** 这会导致部分功能不可用，仅用于测试服务启动。

## 📋 快速修复步骤

### 最简单的方法

1. **检查LocalDB是否运行**
   ```powershell
   sqllocaldb info MSSQLLocalDB
   ```

2. **如果LocalDB未运行，启动它**
   ```powershell
   sqllocaldb start MSSQLLocalDB
   ```

3. **检查SmallTarget数据库**
   ```powershell
   sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "SELECT name FROM sys.databases"
   ```

4. **如果数据库不存在，创建它**
   ```powershell
   sqlcmd -S "(localdb)\MSSQLLocalDB" -Q "CREATE DATABASE SmallTarget"
   ```

5. **重新运行项目**
   ```powershell
   .\run_backend.bat
   ```

## ⚠️ 重要提示

### 数据库要求

项目需要SmallTarget数据库才能正常运行，因为：
- TempCachingService需要数据库连接
- Web3ProviderService依赖TempCachingService
- 大部分API端点需要数据库

### 如果无法创建数据库

如果无法安装LocalDB或创建数据库，可以：
1. 使用现有的SQL Server实例
2. 修改连接字符串指向其他数据库
3. 或暂时使用内存数据库（仅用于开发测试）

## 🎯 下一步操作

1. **先解决数据库连接问题**
   - 安装LocalDB（如果需要）
   - 创建或确认SmallTarget数据库存在

2. **然后重新运行项目**
   ```powershell
   .\debug_run.bat
   ```
   查看详细的启动日志

3. **验证服务启动**
   - 访问 Swagger UI
   - 测试健康检查端点


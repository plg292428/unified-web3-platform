# Kestrel 端口绑定错误修复说明

## 问题描述
服务启动时出现 Kestrel 服务器无法绑定端口的错误，错误发生在 `BindEndpointAsync` 方法中。

## 根本原因
1. **HTTPS 证书配置问题**：launchSettings.json 中配置了 HTTPS 证书环境变量，但证书可能不存在或无效
2. **端口绑定冲突**：Kestrel 尝试同时绑定 HTTP 和 HTTPS 端口，但 HTTPS 证书配置有问题导致失败

## 已实施的修复

### 1. 移除 HTTPS 证书配置
**文件**: `src/Backend/UnifiedPlatform.WebApi/Properties/launchSettings.json`

移除了以下配置：
```json
"ASPNETCORE_Kestrel__Certificates__Default__Password": "",
"ASPNETCORE_Kestrel__Certificates__Default__Path": ""
```

### 2. 禁用 HTTPS 重定向
**文件**: `src/Backend/UnifiedPlatform.WebApi/Program.cs`

已注释掉：
```csharp
// app.UseHttpsRedirection();
```

### 3. 简化 Kestrel 配置
**文件**: `src/Backend/UnifiedPlatform.WebApi/Program.cs`

移除了显式的 `ConfigureKestrel` 配置，让系统使用 `launchSettings.json` 中的默认配置。

## 当前配置

### 服务端口
- **HTTP**: `http://localhost:5195`
- **Swagger UI**: `http://localhost:5195/swagger`
- **Health Check**: `http://localhost:5195/health`

### 启动方式

#### 方式1：使用前台启动脚本（推荐，可查看实时输出）
```batch
.\前台启动服务.bat
```

#### 方式2：使用调试启动脚本（查看详细错误）
```batch
.\debug_run.bat
```

#### 方式3：直接运行
```batch
cd src\Backend\UnifiedPlatform.WebApi
dotnet run
```

## 如果服务已经在运行

如果遇到文件被锁定的错误（如 "文件被 UnifiedPlatform.WebApi (PID) 锁定"），请先停止旧进程：

```batch
.\停止服务.bat
```

或者手动停止：
```batch
taskkill /PID <进程ID> /F
```

## 验证服务是否启动成功

1. **检查端口占用**:
   ```batch
   netstat -ano | findstr ":5195"
   ```

2. **测试健康检查**:
   ```batch
   curl http://localhost:5195/health
   ```

3. **访问 Swagger UI**:
   在浏览器中打开: `http://localhost:5195/swagger`

## 后续优化建议

如果需要启用 HTTPS：

1. **安装开发证书**:
   ```batch
   dotnet dev-certs https --trust
   ```

2. **恢复 HTTPS 配置**:
   - 取消注释 `app.UseHttpsRedirection();`
   - 在 `launchSettings.json` 中配置 HTTPS URL

3. **更新 Kestrel 配置**:
   ```csharp
   builder.WebHost.ConfigureKestrel(options =>
   {
       options.ListenLocalhost(5195, listenOptions =>
       {
           listenOptions.Protocols = HttpProtocols.Http;
       });
       options.ListenLocalhost(5196, listenOptions =>
       {
           listenOptions.Protocols = HttpProtocols.Http2;
           listenOptions.UseHttps();
       });
   });
   ```

## 注意事项

- 当前配置仅使用 HTTP，适合开发环境
- 生产环境应使用 HTTPS
- 如果更改了端口，需要同步更新 `launchSettings.json` 和前端 API 配置



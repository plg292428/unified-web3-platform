# 后端自动部署指南

## 📋 概述

本指南介绍如何配置和使用后端服务的自动化部署流程。

## 🚀 部署方式

### 方式一：一键部署（推荐）

使用批处理脚本快速部署：

```batch
一键部署后端.bat
```

### 方式二：快速部署（跳过备份和迁移）

适用于开发环境，跳过备份和数据库迁移检查：

```batch
配置文件\批处理脚本\快速部署后端.bat
```

### 方式三：PowerShell 脚本部署

直接使用 PowerShell 脚本，支持更多参数：

```powershell
.\配置文件\批处理脚本\自动部署后端.ps1
```

#### PowerShell 脚本参数

- `-SkipBackup`: 跳过备份现有部署
- `-SkipMigration`: 跳过数据库迁移检查
- `-DownloadPath`: 指定发布路径（默认：`src\publish\backend`）
- `-ServicePath`: 指定服务路径（默认：`src\Backend\UnifiedPlatform.WebApi`）

#### 示例

```powershell
# 完整部署（包含备份和迁移检查）
.\配置文件\批处理脚本\自动部署后端.ps1

# 快速部署（跳过备份和迁移）
.\配置文件\批处理脚本\自动部署后端.ps1 -SkipBackup -SkipMigration

# 自定义发布路径
.\配置文件\批处理脚本\自动部署后端.ps1 -DownloadPath "D:\Deploy\Backend"
```

## 🔄 GitHub Actions 自动构建

项目已配置 GitHub Actions 工作流，当代码推送到 `main` 分支时会自动：

1. ✅ 编译后端项目
2. ✅ 运行测试（如果有）
3. ✅ 发布构建产物
4. ✅ 创建 Release 和 Artifacts

### 查看构建状态

1. 访问 GitHub 仓库
2. 点击 "Actions" 标签
3. 查看 "Backend Build and Deploy" 工作流

### 下载构建产物

1. 在 GitHub Actions 页面找到成功的构建
2. 点击构建任务
3. 在 "Artifacts" 部分下载 `backend-build`

## 📦 部署流程说明

自动部署脚本会执行以下步骤：

### 1. 停止现有服务
- 查找并停止所有运行中的后端服务进程
- 等待 2 秒确保进程完全停止

### 2. 备份现有部署（可选）
- 将现有部署备份到带时间戳的目录
- 格式：`backend.backup.YYYYMMDD_HHMMSS`

### 3. 编译和发布
- 还原 NuGet 依赖
- 编译解决方案（Release 配置）
- 发布到指定目录

### 4. 数据库迁移（可选）
- 检查是否有待应用的迁移
- 提示用户是否应用迁移
- 执行数据库更新

### 5. 启动服务
- 询问用户是否立即启动服务
- 在后台启动服务进程

## 🛠️ 手动部署步骤

如果需要手动部署，按以下步骤操作：

### 1. 停止服务

```batch
停止后端服务.bat
```

或手动停止：

```powershell
Get-Process -Name "dotnet" | Where-Object { $_.Path -like "*UnifiedPlatform.WebApi*" } | Stop-Process -Force
```

### 2. 编译项目

```powershell
cd src\Backend
dotnet restore UnifiedPlatform.sln
dotnet build UnifiedPlatform.sln --configuration Release
```

### 3. 发布项目

```powershell
dotnet publish UnifiedPlatform.WebApi\UnifiedPlatform.WebApi.csproj `
    --configuration Release `
    --output ..\..\src\publish\backend
```

### 4. 运行数据库迁移（如需要）

```powershell
dotnet ef database update `
    --project UnifiedPlatform.DbService\UnifiedPlatform.DbService.csproj `
    --startup-project UnifiedPlatform.WebApi\UnifiedPlatform.WebApi.csproj `
    --context StDbContext
```

### 5. 启动服务

```powershell
cd ..\..\src\publish\backend
dotnet UnifiedPlatform.WebApi.dll
```

## 🔍 验证部署

### 检查服务状态

```batch
检查服务状态.bat
```

或手动检查：

```powershell
Get-Process -Name "dotnet" | Where-Object { $_.Path -like "*UnifiedPlatform.WebApi*" }
```

### 测试 API

```batch
test_api.bat
```

或使用浏览器访问：
- Swagger UI: http://localhost:5000/swagger
- Health Check: http://localhost:5000/health

## ⚙️ 配置说明

### 环境变量

确保以下环境变量已配置：
- `ASPNETCORE_ENVIRONMENT`: 环境名称（Development/Production）
- `ConnectionStrings__DefaultConnection`: 数据库连接字符串

### 配置文件

检查 `appsettings.json` 和 `appsettings.Production.json` 配置是否正确。

## 🐛 故障排除

### 问题：服务无法启动

1. 检查端口是否被占用：
   ```powershell
   netstat -ano | findstr :5000
   ```

2. 检查日志文件：
   ```powershell
   Get-Content logs\*.log -Tail 50
   ```

3. 检查数据库连接：
   ```batch
   test_database_connection.bat
   ```

### 问题：编译失败

1. 清理并重新编译：
   ```powershell
   dotnet clean
   dotnet restore
   dotnet build
   ```

2. 检查 .NET SDK 版本：
   ```powershell
   dotnet --version
   ```
   需要 .NET 8.0 SDK

### 问题：数据库迁移失败

1. 检查迁移状态：
   ```batch
   检查迁移状态.bat
   ```

2. 查看迁移历史：
   ```powershell
   dotnet ef migrations list --project src\Backend\UnifiedPlatform.DbService\UnifiedPlatform.DbService.csproj --startup-project src\Backend\UnifiedPlatform.WebApi\UnifiedPlatform.WebApi.csproj --context StDbContext
   ```

## 📝 最佳实践

1. **生产环境部署前**：
   - ✅ 在开发环境测试部署流程
   - ✅ 备份数据库
   - ✅ 检查配置文件
   - ✅ 验证数据库迁移

2. **部署后验证**：
   - ✅ 检查服务状态
   - ✅ 测试 API 端点
   - ✅ 查看日志文件
   - ✅ 监控错误率

3. **回滚方案**：
   - 使用备份目录恢复
   - 或从 GitHub Releases 下载之前的版本

## 🔗 相关脚本

- `一键部署后端.bat` - 一键部署脚本
- `启动后端服务.bat` - 启动服务
- `停止后端服务.bat` - 停止服务
- `检查服务状态.bat` - 检查服务状态
- `检查迁移状态.bat` - 检查数据库迁移状态

## 📞 支持

如遇到问题，请检查：
1. 日志文件
2. GitHub Actions 构建日志
3. 数据库连接状态
4. 端口占用情况


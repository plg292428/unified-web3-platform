# 链上验证和自动更新配置说明

## 📋 功能概述

本项目已实现以下增强功能：

1. **链上交易验证** - 自动验证 Web3 支付订单的链上交易状态
2. **订单状态自动更新** - 定时更新订单支付状态和确认数
3. **支付过期处理** - 自动取消过期订单并恢复库存
4. **性能优化** - 使用内存缓存优化查询性能

---

## ✅ 已实现功能

### 1. 链上交易验证定时任务

**文件位置**：`src/Backend/UnifiedPlatform.WebApi/Services/ScheduleJob/Jobs/HandleOrderPaymentVerificationJob.cs`

**功能**：
- ✅ 自动验证 Web3 支付订单的链上交易状态
- ✅ 更新订单支付状态（成功/失败）
- ✅ 计算并更新交易确认数
- ✅ 自动处理过期支付订单
- ✅ 失败订单自动恢复库存

**执行频率**：每 2 分钟执行一次

**Cron 表达式**：`0 0/2 * * * ?`

### 2. 订单状态自动更新

**自动更新场景**：
- ✅ 交易成功 → 订单状态更新为"已支付"
- ✅ 交易失败 → 订单状态更新为"支付失败"，自动恢复库存
- ✅ 支付过期 → 订单状态更新为"已取消"，自动恢复库存
- ✅ 确认数更新 → 实时更新交易确认数，达到要求后自动确认

### 3. 性能优化

**已实现**：
- ✅ 内存缓存（`AddMemoryCache()`）
- ✅ 数据库连接池（`AddDbContextPool`）
- ✅ 配置缓存服务（`TempCaching`）

---

## ⚙️ 配置说明

### 1. 启用定时任务

**文件**：`src/Backend/UnifiedPlatform.WebApi/Program.cs`

**当前状态**：✅ 已启用

```csharp
// 定时任务（包含订单支付验证）
builder.Services.AddScheduleJobs();
```

### 2. 定时任务配置

**文件**：`src/Backend/UnifiedPlatform.WebApi/Services/ScheduleJob/ScheduleJobExtensions.cs`

**订单支付验证任务**：
```csharp
// 订单支付验证和状态更新 - 每2分钟
q.ScheduleJob<HandleOrderPaymentVerificationJob>(trigger => trigger
    .WithIdentity(typeof(HandleOrderPaymentVerificationJob).ToString())
    .WithDescription(typeof(HandleOrderPaymentVerificationJob).ToString())
    .WithCronSchedule("0 0/2 * * * ?")
);
```

**Cron 表达式说明**：
- `0 0/2 * * * ?` - 每 2 分钟执行一次
- `0 0/5 * * * ?` - 每 5 分钟执行一次（可调整）
- `0 0/1 * * * ?` - 每分钟执行一次（更频繁，但会增加 RPC 调用）

### 3. 确认数要求配置

**文件**：`src/Backend/UnifiedPlatform.WebApi/Services/ScheduleJob/Jobs/HandleOrderPaymentVerificationJob.cs`

**当前配置**：
```csharp
const int requiredConfirmations = 12; // 需要 12 个确认
```

**可调整**：
- **Ethereum/Polygon**：建议 12-24 个确认
- **BSC**：建议 12 个确认
- **TRON**：建议 19 个确认

---

## 🔧 如何调整配置

### 调整执行频率

**修改文件**：`ScheduleJobExtensions.cs`

```csharp
// 改为每 5 分钟执行一次
.WithCronSchedule("0 0/5 * * * ?")

// 改为每分钟执行一次
.WithCronSchedule("0 0/1 * * * ?")
```

### 调整确认数要求

**修改文件**：`HandleOrderPaymentVerificationJob.cs`

```csharp
// 修改确认数要求
const int requiredConfirmations = 24; // 改为 24 个确认
```

### 调整支付过期时间

**修改文件**：`OrderController.cs`（创建订单时）

```csharp
// 修改支付过期时间（当前为 30 分钟）
order.PaymentExpiresAt = now.AddMinutes(60); // 改为 60 分钟
```

---

## 📊 定时任务列表

| 任务名称 | 执行频率 | 功能说明 |
|---------|---------|---------|
| `HandleUserAiTradingOrderJob` | 每分钟 | 处理 AI 合约交易 |
| `HandleUserChainTransactionJob` | 每 3 分钟 | 处理链转账交易 |
| `HandleUserAssetsAndAutoTransferFromJob` | 每 10 分钟 | 更新用户资产和自动转移 |
| **`HandleOrderPaymentVerificationJob`** | **每 2 分钟** | **订单支付验证和状态更新** |
| `DailyUpdateJob` | 每日一次 | 日常更新任务 |

---

## 🚀 启动和验证

### 1. 启动服务

```bash
cd src/Backend/UnifiedPlatform.WebApi
dotnet run
```

### 2. 验证定时任务

**查看日志**：
- 定时任务执行时会输出日志：`HandleOrderPaymentVerificationJob started`
- 验证成功时会输出：`Order {OrderId} payment verified successfully`
- 验证失败时会输出警告日志

**检查数据库**：
- 查看 `Orders` 表的 `PaymentStatus` 和 `Status` 字段
- 查看 `OrderPaymentLogs` 表的日志记录

### 3. 测试链上验证

1. 创建一个 Web3 支付订单
2. 等待 2 分钟后，检查订单状态是否自动更新
3. 查看 `OrderPaymentLogs` 是否有验证日志

---

## ⚠️ 注意事项

### 1. RPC 调用限制

- 定时任务会频繁调用 RPC 节点
- 如果 RPC 节点有调用限制，建议调整执行频率
- 建议使用自己的 RPC 节点或付费 RPC 服务

### 2. 数据库性能

- 定时任务会查询和更新数据库
- 建议在 `Orders` 表上创建索引：
  ```sql
  CREATE INDEX IX_Orders_PaymentStatus_ChainId ON Orders(PaymentStatus, ChainId) WHERE PaymentMode = 1;
  CREATE INDEX IX_Orders_PaymentExpiresAt ON Orders(PaymentExpiresAt) WHERE PaymentExpiresAt IS NOT NULL;
  ```

### 3. 错误处理

- 定时任务已包含错误处理，不会因为单个订单验证失败而停止
- 所有错误都会记录到日志中

---

## 📈 性能优化建议

### 1. 数据库索引

**建议创建以下索引**：

```sql
-- 订单支付状态索引
CREATE INDEX IX_Orders_PaymentStatus_ChainId 
ON Orders(PaymentStatus, ChainId) 
WHERE PaymentMode = 1 AND PaymentStatus IN (1, 2);

-- 支付过期时间索引
CREATE INDEX IX_Orders_PaymentExpiresAt 
ON Orders(PaymentExpiresAt) 
WHERE PaymentExpiresAt IS NOT NULL AND Status = 0;

-- 交易哈希索引（如果经常查询）
CREATE INDEX IX_Orders_PaymentTransactionHash 
ON Orders(PaymentTransactionHash) 
WHERE PaymentTransactionHash IS NOT NULL;
```

### 2. 缓存优化

**已实现**：
- ✅ 内存缓存（`AddMemoryCache()`）
- ✅ 配置缓存（`TempCaching`）

**可扩展**：
- 商品列表缓存（Redis）
- 订单状态缓存（减少数据库查询）

### 3. 批量处理

**当前实现**：逐个处理订单

**可优化**：
- 批量查询交易状态
- 批量更新订单状态

---

## 🔍 故障排查

### 问题1：定时任务未执行

**检查**：
1. 确认 `Program.cs` 中已启用 `AddScheduleJobs()`
2. 查看应用日志，确认任务是否启动
3. 检查 Quartz 配置是否正确

### 问题2：链上验证失败

**检查**：
1. 确认 RPC 节点可访问
2. 检查交易哈希格式是否正确
3. 查看日志中的错误信息

### 问题3：订单状态未更新

**检查**：
1. 确认订单的 `PaymentMode` 为 `Web3`（值为 1）
2. 确认订单有 `PaymentTransactionHash`
3. 查看 `OrderPaymentLogs` 表是否有相关日志

---

## 📝 总结

✅ **已实现功能**：
- 链上交易验证
- 订单状态自动更新
- 支付过期处理
- 库存自动恢复
- 性能优化（缓存、连接池）

✅ **配置状态**：
- 定时任务已启用
- 执行频率：每 2 分钟
- 确认数要求：12 个

✅ **可调整项**：
- 执行频率（Cron 表达式）
- 确认数要求
- 支付过期时间

---

*配置文档生成时间：2025-01-XX*  
*项目路径：`plg/UnifiedWeb3Platform`*


# 后端服务启动问题排查

**问题**: 后端服务无法显示

---

## 一、常见问题及解决方法

### 问题 1: 数据库连接失败

**症状**:
- 服务启动时出现数据库连接错误
- 错误信息包含: "Cannot open database" 或 "Login failed"

**解决方法**:
1. **检查 SQL Server 服务是否运行**
   ```powershell
   Get-Service -Name "MSSQLSERVER" | Select-Object Status, Name
   ```

2. **检查数据库是否存在**
   ```sql
   -- 在 SQL Server Management Studio 中执行
   SELECT name FROM sys.databases WHERE name = 'UnifiedWeb3Platform'
   ```

3. **检查连接字符串**
   - 文件: `src/Backend/UnifiedPlatform.WebApi/appsettings.json`
   - 确认服务器地址、数据库名、用户名、密码正确

4. **创建数据库（如果不存在）**
   ```sql
   CREATE DATABASE UnifiedWeb3Platform;
   ```

---

### 问题 2: 编译错误

**症状**:
- `dotnet build` 失败
- 出现编译错误信息

**解决方法**:
1. **清理并重新编译**
   ```bash
   cd src/Backend/UnifiedPlatform.WebApi
   dotnet clean
   dotnet restore
   dotnet build
   ```

2. **检查错误信息**
   - 查看编译输出的错误信息
   - 根据错误信息修复代码

---

### 问题 3: 端口被占用

**症状**:
- 服务启动失败
- 错误信息: "Address already in use" 或 "端口已被占用"

**解决方法**:
1. **检查端口占用**
   ```powershell
   Get-NetTCPConnection -LocalPort 5000 | Select-Object LocalAddress, LocalPort, State, OwningProcess
   ```

2. **结束占用端口的进程**
   ```powershell
   # 查找占用端口的进程
   $process = Get-NetTCPConnection -LocalPort 5000 | Select-Object -ExpandProperty OwningProcess
   Stop-Process -Id $process -Force
   ```

3. **或者修改端口**
   - 编辑 `appsettings.json` 或 `launchSettings.json`
   - 修改端口号为其他值（如 5001）

---

### 问题 4: 缺少依赖

**症状**:
- 服务启动失败
- 错误信息: "Could not load file or assembly"

**解决方法**:
1. **恢复 NuGet 包**
   ```bash
   cd src/Backend/UnifiedPlatform.WebApi
   dotnet restore
   ```

2. **检查项目引用**
   - 确认所有引用的项目都存在
   - 确认 NuGet 包都已安装

---

## 二、手动启动并查看错误

### 步骤 1: 打开新的终端窗口

```bash
cd "D:\claude code\plg\UnifiedWeb3Platform\src\Backend\UnifiedPlatform.WebApi"
```

### 步骤 2: 编译项目

```bash
dotnet build
```

**检查输出**:
- 如果编译成功，继续下一步
- 如果编译失败，查看错误信息并修复

### 步骤 3: 运行服务

```bash
dotnet run
```

**查看输出**:
- 如果成功，应该看到: `Now listening on: http://localhost:5000`
- 如果有错误，查看错误信息

---

## 三、快速诊断脚本

### 诊断脚本 (diagnose_backend.ps1)

```powershell
Write-Host "检查后端服务状态..." -ForegroundColor Cyan

# 检查端口
$port = Get-NetTCPConnection -LocalPort 5000 -ErrorAction SilentlyContinue
if ($port) {
    Write-Host "[OK] 端口 5000 正在使用" -ForegroundColor Green
} else {
    Write-Host "[INFO] 端口 5000 未被占用" -ForegroundColor Yellow
}

# 检查进程
$process = Get-Process -Name "dotnet" -ErrorAction SilentlyContinue
if ($process) {
    Write-Host "[OK] dotnet 进程正在运行" -ForegroundColor Green
} else {
    Write-Host "[INFO] dotnet 进程未运行" -ForegroundColor Yellow
}

# 测试连接
try {
    $response = Invoke-WebRequest -Uri "http://localhost:5000/swagger" -TimeoutSec 2 -ErrorAction Stop
    Write-Host "[OK] 后端服务正在运行" -ForegroundColor Green
} catch {
    Write-Host "[错误] 无法连接到后端服务" -ForegroundColor Red
    Write-Host "   错误: $($_.Exception.Message)" -ForegroundColor Yellow
}
```

---

## 四、常见错误及解决方案

### 错误 1: "Cannot open database 'UnifiedWeb3Platform'"

**原因**: 数据库不存在或连接字符串错误

**解决**:
1. 创建数据库
2. 检查连接字符串

---

### 错误 2: "Login failed for user"

**原因**: 数据库用户名或密码错误

**解决**:
1. 检查 `appsettings.json` 中的连接字符串
2. 确认 SQL Server 用户存在且有权限

---

### 错误 3: "The specified framework 'Microsoft.AspNetCore.App', version '8.0.0' was not found"

**原因**: .NET 8 SDK 未安装

**解决**:
1. 安装 .NET 8 SDK
2. 或修改项目文件使用已安装的版本

---

### 错误 4: "Port 5000 is already in use"

**原因**: 端口被其他程序占用

**解决**:
1. 结束占用端口的进程
2. 或修改服务端口

---

## 五、推荐启动方式

### 方式 1: 使用 Visual Studio

1. 打开 `UnifiedPlatform.WebApi` 项目
2. 按 `F5` 运行
3. 查看输出窗口的错误信息

### 方式 2: 使用命令行（推荐）

```bash
cd src/Backend/UnifiedPlatform.WebApi
dotnet run
```

**优点**:
- 可以看到完整的错误信息
- 方便调试

---

## 六、验证服务启动

### 方法 1: 访问 Swagger UI

打开浏览器访问: `http://localhost:5000/swagger`

**预期结果**:
- 看到 Swagger UI 界面
- 可以查看 API 文档

### 方法 2: 测试 API

```powershell
Invoke-RestMethod -Uri "http://localhost:5000/api/store/categories" -Method Get
```

**预期结果**:
- 返回 JSON 数据
- 或者返回错误信息（但至少服务在运行）

---

## 七、如果仍然无法启动

请提供以下信息：
1. **编译输出**: `dotnet build` 的完整输出
2. **运行输出**: `dotnet run` 的完整输出
3. **错误信息**: 具体的错误消息
4. **数据库状态**: SQL Server 是否运行，数据库是否存在

---

**排查指南生成时间**: 2025-11-12


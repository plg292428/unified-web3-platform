# 阶段4: 环境优化配置指南

## 目标
优化生产环境配置，提升安全性和性能

## 当前状态分析

### 1. 生产环境配置
- ⚠️ **数据库密码**: 使用占位符 `YourPassword`，需要替换
- ⚠️ **JWT 密钥**: 使用简单密钥，生产环境应使用更安全的密钥
- ⚠️ **HTTPS**: 当前已禁用，生产环境建议启用
- ⚠️ **AllowedHosts**: 设置为 `*`（允许所有主机），生产环境应限制

### 2. 开发环境配置
- ✅ 使用 LocalDB，配置正确
- ✅ Swagger UI 仅在开发环境启用
- ✅ HTTP 配置适合开发环境

## 优化方案

### 4.1 生产环境配置优化

#### 步骤 1: 更新数据库连接字符串

**当前配置**:
```json
"DefaultConnection": "Server=localhost;Database=UnifiedWeb3Platform;User Id=sa;Password=YourPassword;TrustServerCertificate=True;"
```

**优化建议**:
1. 替换 `YourPassword` 为实际强密码
2. 考虑使用专用数据库用户（而非 sa）
3. 生产环境应考虑使用连接池配置

#### 步骤 2: 增强 JWT 安全性

**当前配置**:
```json
"SecurityKey": "!@#UnifiedWeb3Platform2025#@!"
```

**优化建议**:
1. 使用环境变量存储密钥
2. 使用更长的随机密钥（至少 32 字符）
3. 定期轮换密钥

#### 步骤 3: 限制允许的主机

**当前配置**:
```json
"AllowedHosts": "*"
```

**优化建议**:
```json
"AllowedHosts": "yourdomain.com;www.yourdomain.com"
```

### 4.2 HTTPS 配置

#### 当前状态
- HTTPS 重定向已禁用（开发环境）
- 生产环境建议启用 HTTPS

#### 配置 HTTPS 的步骤

**方法 1: 使用 ASP.NET Core 开发证书（开发环境）**
```bash
dotnet dev-certs https --trust
```

**方法 2: 配置 Kestrel HTTPS（生产环境）**
在 `Program.cs` 中配置：
```csharp
builder.WebHost.ConfigureKestrel(options =>
{
    options.Listen(IPAddress.Any, 5000, listenOptions =>
    {
        listenOptions.Protocols = HttpProtocols.Http;
    });
    options.Listen(IPAddress.Any, 5001, listenOptions =>
    {
        listenOptions.Protocols = HttpProtocols.Http2;
        listenOptions.UseHttps("path/to/certificate.pfx", "password");
    });
});
```

**方法 3: 使用环境变量配置证书**
```json
{
  "Kestrel": {
    "Certificates": {
      "Default": {
        "Path": "path/to/certificate.pfx",
        "Password": "certificate-password"
      }
    }
  }
}
```

### 4.3 安全策略配置

#### CORS 配置优化

**当前配置**:
```csharp
options.AddPolicy("Any", policy =>
{
    policy.AllowAnyHeader();
    policy.AllowAnyOrigin();
    policy.AllowAnyMethod();
});
```

**生产环境优化**:
```csharp
options.AddPolicy("Production", policy =>
{
    policy.WithOrigins("https://yourdomain.com", "https://www.yourdomain.com")
          .AllowAnyHeader()
          .AllowAnyMethod()
          .AllowCredentials();
});
```

#### 日志配置优化

**当前配置**:
```json
"Logging": {
  "LogLevel": {
    "Default": "Information",
    "Microsoft.AspNetCore": "Warning"
  }
}
```

**生产环境优化**:
```json
"Logging": {
  "LogLevel": {
    "Default": "Warning",
    "Microsoft.AspNetCore": "Warning",
    "Microsoft.EntityFrameworkCore": "Error"
  },
  "File": {
    "Path": "logs/app.log",
    "RollingInterval": "Day"
  }
}
```

## 实施步骤

### 步骤 1: 创建环境变量配置模板

创建 `.env.production` 或使用环境变量：
- `DB_PASSWORD`: 数据库密码
- `JWT_SECURITY_KEY`: JWT 安全密钥
- `TRON_API_KEY`: TRON API 密钥（如果需要）

### 步骤 2: 更新 appsettings.Production.json

需要手动更新以下内容：
1. 数据库连接字符串的密码
2. JWT SecurityKey（如果使用强密钥）
3. AllowedHosts（限制为实际域名）

### 步骤 3: 配置 HTTPS（可选）

根据部署环境选择：
- **开发环境**: 使用开发证书
- **生产环境**: 使用正式 SSL 证书

### 步骤 4: 配置安全策略

更新 CORS、日志和其他安全配置

## 注意事项

1. **敏感信息**: 不要将密码和密钥提交到版本控制系统
2. **环境变量**: 生产环境建议使用环境变量或密钥管理服务
3. **HTTPS**: 生产环境强烈建议启用 HTTPS
4. **备份**: 更新配置前备份现有配置

## 配置文件位置

- 开发环境: `appsettings.json`
- 生产环境: `appsettings.Production.json`
- 程序配置: `Program.cs`

## 验证方法

1. 检查配置文件是否正确更新
2. 测试生产环境配置（使用生产环境变量）
3. 验证 HTTPS 连接（如果启用）
4. 测试安全策略是否生效



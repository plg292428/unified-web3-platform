# 数据库列名错误修复说明

**修复时间**: 2025-11-12

---

## 一、问题描述

### 错误信息
```
列名 'ChainNetworkConfigChainId' 无效
列名 'UserUid' 无效
```

### 错误原因
EF Core 在查询 `Order` 实体时，尝试加载导航属性（`Chain` 和 `UidNavigation`），但数据库表中不存在这些列名。

**实际数据库列名**:
- `ChainId` (不是 `ChainNetworkConfigChainId`)
- `Uid` (不是 `UserUid`)

**EF Core 配置**:
- `Order.Chain` 导航属性配置为使用 `ChainId` 作为外键
- `Order.UidNavigation` 导航属性配置为使用 `Uid` 作为外键

但 EF Core 在查询时仍然尝试加载这些导航属性，导致查询了不存在的列。

---

## 二、修复方案

### 方案：使用 `AsNoTracking()` 避免加载导航属性

在 `HandleOrderPaymentVerificationJob.cs` 中，所有查询 `Order` 实体的地方都添加了 `AsNoTracking()`，避免 EF Core 自动加载导航属性。

### 修改内容

#### 1. `VerifyWeb3Payments` 方法
```csharp
// 修改前
var ordersToVerify = await _dbContext.Orders
    .Where(o => ...)
    .ToListAsync();

// 修改后
var ordersToVerify = await _dbContext.Orders
    .AsNoTracking()  // 添加此行
    .Where(o => ...)
    .ToListAsync();
```

**注意**: 由于使用了 `AsNoTracking()`，实体不会被跟踪，无法直接更新。需要先使用 `FindAsync` 重新加载实体，然后再更新。

```csharp
// 重新加载订单以进行更新
var orderToUpdate = await _dbContext.Orders.FindAsync(order.OrderId);
if (orderToUpdate == null)
{
    continue;
}

// 然后更新 orderToUpdate
orderToUpdate.PaymentStatus = StorePaymentStatus.Confirmed;
// ...
```

#### 2. `HandleExpiredPayments` 方法
```csharp
// 修改前
var expiredOrders = await _dbContext.Orders
    .Where(o => ...)
    .ToListAsync();

// 修改后
var expiredOrders = await _dbContext.Orders
    .AsNoTracking()  // 添加此行
    .Where(o => ...)
    .ToListAsync();
```

同样，更新时需要先 `FindAsync` 再更新。

#### 3. `UpdatePaymentConfirmations` 方法
```csharp
// 修改前
var ordersToUpdate = await _dbContext.Orders
    .Where(o => ...)
    .ToListAsync();

// 修改后
var ordersToUpdate = await _dbContext.Orders
    .AsNoTracking()  // 添加此行
    .Where(o => ...)
    .ToListAsync();
```

---

## 三、为什么会出现这个问题？

### EF Core 导航属性加载机制

当 EF Core 查询实体时，如果实体有导航属性，EF Core 可能会尝试加载这些导航属性。对于外键关系，EF Core 会：

1. **自动生成外键列名**: 如果导航属性名为 `Chain`，目标实体为 `ChainNetworkConfig`，EF Core 可能会生成 `ChainNetworkConfigChainId` 作为外键列名。

2. **使用配置的外键**: 如果明确配置了外键（如 `HasForeignKey(d => d.ChainId)`），EF Core 应该使用配置的外键列名。

3. **问题**: 在某些情况下，EF Core 的模型快照（Model Snapshot）可能与实际数据库结构不一致，导致查询时使用了错误的列名。

### 解决方案的优势

使用 `AsNoTracking()` 的优势：
- ✅ 避免加载导航属性，防止列名错误
- ✅ 提高查询性能（不需要跟踪实体）
- ✅ 减少内存占用

缺点：
- ⚠️ 需要手动重新加载实体才能更新（使用 `FindAsync`）

---

## 四、验证修复

### 验证步骤
1. 重新编译项目
2. 启动后端服务
3. 检查服务日志，确认没有列名错误
4. 访问 `http://localhost:5000/swagger` 验证服务

### 预期结果
- ✅ 服务启动成功
- ✅ 没有数据库列名错误
- ✅ 可以访问 Swagger UI
- ✅ 定时任务可以正常运行

---

## 五、其他注意事项

### 如果问题仍然存在

1. **检查数据库表结构**
   ```sql
   SELECT COLUMN_NAME, DATA_TYPE 
   FROM INFORMATION_SCHEMA.COLUMNS 
   WHERE TABLE_NAME = 'Orders'
   ```

2. **检查 EF Core 模型快照**
   - 文件: `Migrations/StDbContextModelSnapshot.cs`
   - 确认 `Order` 实体的配置是否正确

3. **重新生成迁移**
   ```bash
   cd src/Backend/UnifiedPlatform.DbService
   dotnet ef migrations remove
   dotnet ef migrations add FixOrderColumns
   dotnet ef database update
   ```

---

**修复完成时间**: 2025-11-12


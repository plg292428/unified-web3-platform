# 性能优化配置指南

## 📋 概述

本文档说明如何配置和优化链上验证、自动更新和性能优化功能。

---

## ✅ 已实现的功能

### 1. 链上交易验证定时任务 ✅

**文件**：`src/Backend/UnifiedPlatform.WebApi/Services/ScheduleJob/Jobs/HandleOrderPaymentVerificationJob.cs`

**功能**：
- ✅ 自动验证 Web3 支付订单的链上交易状态
- ✅ 更新订单支付状态（成功/失败）
- ✅ 计算并更新交易确认数
- ✅ 自动处理过期支付订单
- ✅ 失败订单自动恢复库存

**执行频率**：每 2 分钟

### 2. 自动更新功能 ✅

**自动更新场景**：
- ✅ 交易成功 → 订单状态自动更新为"已支付"
- ✅ 交易失败 → 订单状态自动更新为"支付失败"，自动恢复库存
- ✅ 支付过期 → 订单状态自动更新为"已取消"，自动恢复库存
- ✅ 确认数更新 → 实时更新交易确认数，达到要求后自动确认

### 3. 性能优化 ✅

**已实现**：
- ✅ 内存缓存（`AddMemoryCache()`）
- ✅ 数据库连接池（`AddDbContextPool`）
- ✅ 配置缓存服务（`TempCaching`）

---

## ⚙️ 配置步骤

### 步骤 1：启用定时任务（已完成 ✅）

**文件**：`src/Backend/UnifiedPlatform.WebApi/Program.cs`

```csharp
// 定时任务（包含订单支付验证）
builder.Services.AddScheduleJobs();
```

**状态**：✅ 已启用

### 步骤 2：配置执行频率（可选）

**文件**：`src/Backend/UnifiedPlatform.WebApi/Services/ScheduleJob/ScheduleJobExtensions.cs`

**当前配置**：
```csharp
// 订单支付验证和状态更新 - 每2分钟
q.ScheduleJob<HandleOrderPaymentVerificationJob>(trigger => trigger
    .WithIdentity(typeof(HandleOrderPaymentVerificationJob).ToString())
    .WithDescription(typeof(HandleOrderPaymentVerificationJob).ToString())
    .WithCronSchedule("0 0/2 * * * ?")
);
```

**调整方法**：
- `0 0/2 * * * ?` - 每 2 分钟（当前）
- `0 0/5 * * * ?` - 每 5 分钟（降低 RPC 调用频率）
- `0 0/1 * * * ?` - 每分钟（更频繁，但会增加 RPC 调用）

### 步骤 3：配置确认数要求（可选）

**文件**：`src/Backend/UnifiedPlatform.WebApi/Services/ScheduleJob/Jobs/HandleOrderPaymentVerificationJob.cs`

**当前配置**：
```csharp
const int requiredConfirmations = 12; // 需要 12 个确认
```

**推荐配置**：
- **Ethereum**：12-24 个确认
- **Polygon**：12 个确认
- **BSC**：12 个确认
- **TRON**：19 个确认

### 步骤 4：配置支付过期时间（可选）

**文件**：`src/Backend/UnifiedPlatform.WebApi/Controllers/OrderController.cs`

**当前配置**：
```csharp
// 设置支付过期时间（默认 30 分钟）
order.PaymentExpiresAt = now.AddMinutes(30);
```

**调整方法**：
```csharp
order.PaymentExpiresAt = now.AddMinutes(60); // 改为 60 分钟
```

### 步骤 5：创建数据库索引（推荐 ⭐）

**文件**：`数据库索引优化建议.sql`

**执行步骤**：
1. 打开 SQL Server Management Studio
2. 连接到数据库
3. 执行 `数据库索引优化建议.sql` 中的 SQL 语句

**重要索引**：
- `IX_Orders_PaymentStatus_ChainId_PaymentMode` - 支付状态查询
- `IX_Orders_PaymentExpiresAt_Status` - 过期订单查询
- `IX_Orders_PaymentTransactionHash` - 交易哈希查询

---

## 🔧 详细配置说明

### 1. Cron 表达式说明

**格式**：`秒 分 时 日 月 周 [年]`

**示例**：
- `0 0/2 * * * ?` - 每 2 分钟执行一次
- `0 0/5 * * * ?` - 每 5 分钟执行一次
- `0 0 0/1 * * ?` - 每小时执行一次
- `0 0 0 * * ?` - 每天 0 点执行一次

### 2. 确认数要求说明

**确认数**：交易被包含在区块后，后续产生的区块数量

**为什么需要确认数**：
- 防止链重组（Reorg）
- 确保交易最终确认
- 提高支付安全性

**推荐值**：
- 快速链（BSC、Polygon）：12 个确认
- 标准链（Ethereum）：12-24 个确认
- 慢速链（Bitcoin）：6 个确认

### 3. 支付过期时间说明

**作用**：
- 防止订单长期处于待支付状态
- 自动释放库存
- 提高系统资源利用率

**推荐值**：
- 快速链：30 分钟
- 标准链：60 分钟
- 慢速链：120 分钟

---

## 📊 性能优化建议

### 1. 数据库索引优化

**执行 SQL**：`数据库索引优化建议.sql`

**效果**：
- 提升订单查询速度 10-100 倍
- 减少数据库 CPU 使用率
- 提升定时任务执行效率

### 2. RPC 节点优化

**建议**：
- 使用自己的 RPC 节点（避免限流）
- 使用付费 RPC 服务（如 Infura、Alchemy）
- 配置多个 RPC 节点（负载均衡）

**配置位置**：`appsettings.json`
```json
{
  "ChainNetworkConfigs": {
    "RpcUrl": "https://your-rpc-node.com",
    "RpcApiKey": "your-api-key"
  }
}
```

### 3. 缓存优化

**已实现**：
- ✅ 内存缓存（配置数据）
- ✅ 数据库连接池

**可扩展**：
- Redis 缓存（商品列表、订单状态）
- 分布式缓存（多实例部署）

### 4. 批量处理优化

**当前实现**：逐个处理订单

**可优化**：
- 批量查询交易状态（减少 RPC 调用）
- 批量更新订单状态（减少数据库操作）

---

## 🚀 启动和验证

### 1. 启动服务

```bash
cd src/Backend/UnifiedPlatform.WebApi
dotnet run
```

### 2. 验证定时任务

**查看日志**：
```
[Information] HandleOrderPaymentVerificationJob started
[Information] Found X orders to verify
[Information] Order {OrderId} payment verified successfully
```

**检查数据库**：
```sql
-- 查看待验证的订单
SELECT OrderId, OrderNumber, PaymentStatus, PaymentTransactionHash, PaymentConfirmations
FROM Orders
WHERE PaymentMode = 1 
  AND PaymentStatus = 1  -- AwaitingOnChainConfirmation
  AND Status = 0;  -- PendingPayment

-- 查看支付日志
SELECT * FROM OrderPaymentLogs
WHERE EventType IN ('payment_verified', 'payment_failed', 'payment_expired')
ORDER BY CreateTime DESC;
```

### 3. 测试链上验证

1. **创建测试订单**：
   - 创建一个 Web3 支付订单
   - 记录订单号和交易哈希

2. **等待验证**：
   - 等待 2 分钟后，检查订单状态
   - 查看 `OrderPaymentLogs` 表是否有验证日志

3. **验证结果**：
   - 交易成功 → `PaymentStatus = 2`（Confirmed），`Status = 1`（Paid）
   - 交易失败 → `PaymentStatus = 3`（Failed）
   - 支付过期 → `PaymentStatus = 4`（Cancelled），`Status = 2`（Cancelled）

---

## ⚠️ 注意事项

### 1. RPC 调用限制

**问题**：频繁调用 RPC 节点可能触发限流

**解决方案**：
- 调整执行频率（改为每 5 分钟）
- 使用多个 RPC 节点（负载均衡）
- 使用付费 RPC 服务

### 2. 数据库性能

**问题**：大量订单时，查询可能较慢

**解决方案**：
- 创建数据库索引（执行 `数据库索引优化建议.sql`）
- 优化查询条件（只查询必要的订单）
- 使用分页查询

### 3. 错误处理

**已实现**：
- ✅ 单个订单验证失败不影响其他订单
- ✅ 所有错误都记录到日志
- ✅ 异常不会导致定时任务停止

### 4. 并发控制

**已实现**：
- ✅ `[DisallowConcurrentExecution]` 防止并发执行
- ✅ 使用数据库事务保证数据一致性

---

## 📈 监控和日志

### 1. 日志级别

**配置位置**：`appsettings.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "UnifiedPlatform.WebApi.Services.ScheduleJob": "Information"
    }
  }
}
```

### 2. 关键日志

**成功日志**：
```
[Information] HandleOrderPaymentVerificationJob started
[Information] Found X orders to verify
[Information] Order {OrderId} payment verified successfully
```

**警告日志**：
```
[Warning] Order {OrderId} has no ChainId
[Warning] Cannot get Web3Provider for ChainId {ChainId}
[Warning] Transaction not found for Order {OrderId}
```

**错误日志**：
```
[Error] Error verifying payment for Order {OrderId}
[Error] Error getting current block number
```

### 3. 性能监控

**建议监控指标**：
- 定时任务执行时间
- RPC 调用成功率
- 数据库查询时间
- 订单验证成功率

---

## 🔍 故障排查

### 问题1：定时任务未执行

**检查步骤**：
1. 确认 `Program.cs` 中已启用 `AddScheduleJobs()`
2. 查看应用日志，确认任务是否启动
3. 检查 Quartz 配置是否正确

**解决方案**：
```csharp
// 确保已启用
builder.Services.AddScheduleJobs();
```

### 问题2：链上验证失败

**检查步骤**：
1. 确认 RPC 节点可访问
2. 检查交易哈希格式是否正确
3. 查看日志中的错误信息

**解决方案**：
- 检查 RPC URL 配置
- 验证交易哈希是否正确
- 确认网络连接正常

### 问题3：订单状态未更新

**检查步骤**：
1. 确认订单的 `PaymentMode` 为 `Web3`（值为 1）
2. 确认订单有 `PaymentTransactionHash`
3. 查看 `OrderPaymentLogs` 表是否有相关日志

**解决方案**：
- 检查订单数据是否正确
- 查看定时任务日志
- 手动触发验证（调用 API）

### 问题4：性能问题

**检查步骤**：
1. 查看数据库查询时间
2. 检查 RPC 调用延迟
3. 查看服务器资源使用情况

**解决方案**：
- 创建数据库索引
- 优化查询条件
- 调整执行频率
- 使用更快的 RPC 节点

---

## 📝 配置检查清单

### ✅ 基础配置

- [x] 定时任务已启用（`Program.cs`）
- [x] 定时任务已注册（`ScheduleJobExtensions.cs`）
- [x] 执行频率已配置（每 2 分钟）
- [x] 确认数要求已配置（12 个）

### ✅ 数据库优化

- [ ] 数据库索引已创建（执行 `数据库索引优化建议.sql`）
- [ ] 统计信息已更新
- [ ] 索引使用情况已检查

### ✅ 性能优化

- [x] 内存缓存已启用
- [x] 数据库连接池已配置
- [ ] Redis 缓存已配置（可选）

### ✅ 监控和日志

- [x] 日志级别已配置
- [ ] 性能监控已设置（可选）
- [ ] 告警规则已配置（可选）

---

## 🎯 快速开始

### 1. 启用功能（已完成 ✅）

定时任务已在 `Program.cs` 中启用，无需额外配置。

### 2. 创建数据库索引（推荐 ⭐）

```sql
-- 执行 数据库索引优化建议.sql 中的 SQL 语句
```

### 3. 调整配置（可选）

根据实际需求调整：
- 执行频率（Cron 表达式）
- 确认数要求
- 支付过期时间

### 4. 启动服务

```bash
dotnet run
```

### 5. 验证功能

- 创建测试订单
- 等待 2 分钟后检查订单状态
- 查看日志确认验证过程

---

## 📚 相关文档

- [项目完整性报告.md](./项目完整性报告.md)
- [数据库索引优化建议.sql](./数据库索引优化建议.sql)
- [链上验证和自动更新配置说明.md](./链上验证和自动更新配置说明.md)

---

*配置指南生成时间：2025-01-XX*  
*项目路径：`plg/UnifiedWeb3Platform`*

